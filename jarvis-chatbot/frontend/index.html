<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jarvis Voice Chatbot</title>
  <style>
    #transcript, #response {
      margin-top: 20px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <button id="start">üé§ Speak</button>
  <button id="stop">‚èπÔ∏è Stop</button>
  <div id="transcript"></div>
  <div id="response"></div>

  <script>
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const transcriptDiv = document.getElementById('transcript');
    const responseDiv = document.getElementById('response');
    const synth = window.speechSynthesis;

    // Initialize recognition once
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Speech Recognition API not supported in this browser.");
    }
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;

    if (recognition) {
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.continuous = false;

      recognition.onstart = () => {
        startBtn.disabled = true;
        responseDiv.textContent = 'Listening...';
      };

      recognition.onresult = async (event) => {
        const text = event.results[0][0].transcript;
        transcriptDiv.textContent = 'You: ' + text;

        try {
          const res = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: text })
          });

          const data = await res.json();
          responseDiv.textContent = 'Jarvis: ' + data.response;

          const utter = new SpeechSynthesisUtterance(data.response);
          synth.speak(utter);
        } catch (err) {
          responseDiv.textContent = 'Error connecting to server.';
          console.error(err);
        }
      };

      recognition.onerror = (event) => {
        responseDiv.textContent = 'Error: ' + event.error;
        startBtn.disabled = false;
      };

      recognition.onend = () => {
        startBtn.disabled = false;
        if (!synth.speaking) {
          responseDiv.textContent += ' (You can speak again)';
        }
      };
    }

    startBtn.onclick = () => {
      if (recognition) recognition.start();
    };

    stopBtn.onclick = () => {
      if (recognition) recognition.stop();  // Stop listening
      if (synth.speaking) synth.cancel();   // Stop speech
      responseDiv.textContent = 'Stopped.';
      startBtn.disabled = false;
    };
  </script>
</body>
</html>
